[tools]
lua-language-server = "latest"
neovim = "latest"
stylua = "latest"
uv = "latest"

[tasks."deps:download"]
description = "Clone LuaLS type stubs for busted, luassert, and luvit-meta"
run = """
  git clone https://github.com/Bilal2453/luvit-meta.git .dependencies/luvit-meta 2>/dev/null || true
  git clone https://github.com/LuaCATS/busted.git       .dependencies/busted      2>/dev/null || true
  git clone https://github.com/LuaCATS/luassert.git     .dependencies/luassert    2>/dev/null || true
"""

[tasks.lint]
description = "Run luacheck static analysis"
run = "luacheck lua plugin scripts spec"

[tasks."fmt:check"]
description = "Check Lua and Markdown formatting (stylua + mdformat)"
depends = ["fmt:check:lua", "fmt:check:md"]

[tasks."fmt:check:lua"]
description = "Check Lua formatting with stylua"
run = "stylua lua plugin scripts spec --color always --check"

[tasks."fmt:check:md"]
description = "Check Markdown formatting with mdformat"
run = "uv tool run mdformat --check README.md CONTRIBUTING.md"

[tasks.fmt]
description = "Apply Lua and Markdown formatting"
depends = ["fmt:lua", "fmt:md"]

[tasks."fmt:lua"]
description = "Apply Lua formatting with stylua"
run = "stylua lua plugin scripts spec"

[tasks."fmt:md"]
description = "Apply Markdown formatting with mdformat"
run = "uv tool run mdformat README.md CONTRIBUTING.md"

[tasks.test]
description = "Run busted unit tests"
run = "eval \"$(luarocks path --bin)\" && busted spec/better_gitui/"

[tasks.coverage]
description = "Generate HTML coverage report (requires: luarocks install luacov luacov-multiple)"
run = """
  nvim -u NONE -U NONE -N -i NONE --headless -c "luafile scripts/luacov.lua" -c "quit"
  eval "$(luarocks path --bin)" && luacov --reporter multiple.html
"""

[tasks.llscheck]
description = "Run LuaLS type-checker via llscheck (requires: luarocks install llscheck)"
run = """
  VIMRUNTIME=$(nvim --clean --headless --cmd 'lua io.write(os.getenv("VIMRUNTIME"))' --cmd 'quit')
  export VIMRUNTIME
  eval "$(luarocks path --bin)" && llscheck --configpath "${LLSCHECK_CONFIG:-.luarc.json}" .
"""

[tasks.check]
description = "Run all local checks: lint, fmt:check, test"
depends = ["lint", "fmt:check", "test"]

